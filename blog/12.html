<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
  <script src="/assets/js/close_copy.js"></script>
  

  
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  <title>MQTT学习笔记</title>

  <link rel="shortcut icon" type="image/x-icon" href="/assets/private/icons/huangdayu.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head><body a="light">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">Back</a><article>
  
  <h1 class="post-header">MQTT学习笔记</h1>

  <p class="post-meta">
    <time datetime="2017-07-09 00:27:29 +0800">2017-07-09</time>
  </p>
  
  <h1 id="mqtt协议说明">MQTT协议说明</h1>

<p><a href="http://mqtt.org/">MQTT</a>（消息队列遥测传输）是IBM开发的一个即时通讯协议，是当今物联网的网络层的重要组成部分，该协议的开发也主要是面向物联网的。MQTT协议是为大量计算能力有限，且工作在低带宽，不可靠网络的远程传感器设。</p>

<h1 id="mqtt协议特点">MQTT协议特点</h1>

<ol>
  <li>使用发布/订阅消息模式，提供一对多的消息发布，解除应用程序耦合；</li>
  <li>对负载内容屏蔽的消息传输；</li>
  <li>使用 TCP/IP 提供网络连接；</li>
  <li>有三种消息发布服务质量：</li>
  <li>“至多一次”，消息发布完全依赖底层 TCP/IP 网络。会发生消息丢失或重复。这一级别可用于如下情况，环境传感器数据，丢失一次读记录无所谓，因为不久后还会有第二次发送。</li>
  <li>“至少一次”，确保消息到达，但消息重复可能会发生。</li>
  <li>“只有一次”，确保消息到达一次。这一级别可用于如下情况，在计费系统中，消息重复或丢失会导致不正确的结果。</li>
  <li>小型传输，开销很小（固定长度的头部是 2 字节），协议交换最小化，以降低网络流量；</li>
  <li>使用 Last Will 和 Testament 特性通知有关各方客户端异常中断的机制；</li>
</ol>

<!-- more -->

<h1 id="mqtt-broker">MQTT Broker</h1>

<p>比较出名的有以下几个MQTT代理服务器：</p>

<ul>
  <li><a href="http://emqtt.com/">EMQTT</a></li>
  <li><a href="http://activemq.apache.org/apollo">Apache-Apollo</a></li>
  <li><a href="https://mosquitto.org/">Mosquitto</a></li>
</ul>

<h2 id="emqtt">EMQTT</h2>

<h3 id="下载编译之后的软件包">下载编译之后的软件包</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://emqtt.com/static/brokers/emqttd-ubuntu16.04-v2.3.6.zip
<span class="nb">sudo </span>unzip emqttd-ubuntu16.04-v2.3.6.zip
</code></pre></div></div>

<h3 id="打开">打开</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./emqttd/bin/emqttd start
</code></pre></div></div>

<h3 id="关闭">关闭</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./emqttd/bin/emqttd stop
</code></pre></div></div>

<h3 id="查询状态">查询状态</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./emqttd/bin/emqttd_ctl status
</code></pre></div></div>

<h3 id="通过api发送消息给emqtt代理服务器">通过API发送消息给EMQTT代理服务器</h3>

<blockquote>
  <p>Http Post To EMQTT 封装</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.http.HttpEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.ClientProtocolException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.HttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.config.RequestConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.methods.HttpPost</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.conn.ConnectionRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.entity.StringEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.DefaultHttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.HttpClientBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.params.CoreConnectionPNames</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.util.EntityUtils</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">httpAPIPublishMqttPayload</span><span class="o">(</span><span class="nc">String</span> <span class="n">json</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">Encoder</span> <span class="n">encoder</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">getEncoder</span><span class="o">();</span>
		<span class="kt">byte</span><span class="o">[]</span> <span class="n">textByte</span><span class="o">;</span>
		<span class="c1">// 编码</span>
		<span class="nc">String</span> <span class="n">encodedText</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">textByte</span> <span class="o">=</span> <span class="s">"admin:public"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span><span class="c1">//对账号和密码进行编码</span>
			<span class="n">encodedText</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">textByte</span><span class="o">);</span><span class="c1">// 编码</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">UnsupportedEncodingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="nc">RequestConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="nc">RequestConfig</span><span class="o">.</span><span class="na">custom</span><span class="o">().</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="mi">5000</span><span class="o">).</span><span class="na">setSocketTimeout</span><span class="o">(</span><span class="mi">3000</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
		<span class="nc">HttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="nc">HttpClientBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">().</span><span class="na">setDefaultRequestConfig</span><span class="o">(</span><span class="n">config</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

		<span class="nc">HttpPost</span> <span class="n">httppost</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpPost</span><span class="o">(</span><span class="err">“</span><span class="nl">http:</span><span class="c1">//yibuwulianwang.com:18000/api/v2/mqtt/publish”);</span>

		<span class="n">httppost</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">,</span> <span class="s">"Basic "</span> <span class="o">+</span> <span class="n">encodedText</span><span class="o">);</span>
		<span class="n">httppost</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"application/json"</span><span class="o">);</span>
		<span class="c1">// httppost.setHeader("Content-Length", String.valueOf(postStrBytes.length));</span>

		<span class="nc">String</span> <span class="n">postjson</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="err">“</span><span class="n">json</span><span class="err">”</span><span class="o">));</span><span class="c1">//payload json</span>
		<span class="c1">// 构建消息实体</span>
		<span class="nc">StringEntity</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringEntity</span><span class="o">(</span><span class="n">postjson</span><span class="o">,</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">));</span>
		<span class="n">entity</span><span class="o">.</span><span class="na">setContentEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
		<span class="c1">// 发送json格式的请求</span>
		<span class="n">entity</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">);</span>
		<span class="n">httppost</span><span class="o">.</span><span class="na">setEntity</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>

		<span class="nc">HttpResponse</span> <span class="n">response</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">response</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">httppost</span><span class="o">);</span>
			<span class="c1">// 消息返回码</span>
			<span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getStatusLine</span><span class="o">().</span><span class="na">getStatusCode</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">statusCode</span> <span class="o">!=</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">SC_OK</span><span class="o">)</span> <span class="o">{</span>
				<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"REQUEST EMQTT HTTP API ERR:"</span> <span class="o">+</span> <span class="n">statusCode</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"REQUEST EMQTT HTTP API SUCCESS:"</span> <span class="o">+</span> <span class="n">statusCode</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="nc">HttpEntity</span> <span class="n">httpEntity</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getEntity</span><span class="o">();</span>
			<span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">httpEntity</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="nc">EntityUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">httpEntity</span><span class="o">,</span> <span class="s">"utf-8"</span><span class="o">);</span>
				<span class="nc">EntityUtils</span><span class="o">.</span><span class="na">consume</span><span class="o">(</span><span class="n">httpEntity</span><span class="o">);</span>
				<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"EMQTT HTTP API RESPONSE RESULT:"</span><span class="o">+</span><span class="n">result</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClientProtocolException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>Http Post 封装</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.HttpEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.HttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.config.RequestConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.methods.HttpPost</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.entity.StringEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.HttpClientBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.util.EntityUtils</span><span class="o">;</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">postAPI</span><span class="o">(</span><span class="nc">String</span> <span class="n">url</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">json</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">RequestConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="nc">RequestConfig</span><span class="o">.</span><span class="na">custom</span><span class="o">().</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="mi">35000</span><span class="o">).</span><span class="na">setConnectionRequestTimeout</span><span class="o">(</span><span class="mi">35000</span><span class="o">)</span>
				<span class="o">.</span><span class="na">setSocketTimeout</span><span class="o">(</span><span class="mi">60000</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
		<span class="nc">HttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="nc">HttpClientBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">().</span><span class="na">setDefaultRequestConfig</span><span class="o">(</span><span class="n">config</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
		<span class="nc">HttpPost</span> <span class="n">httpPost</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpPost</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
		<span class="n">httpPost</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"application/json"</span><span class="o">);</span>
		<span class="nc">String</span> <span class="n">postjson</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"请求接口( "</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s">" )的数据：\n"</span> <span class="o">+</span> <span class="n">postjson</span><span class="o">);</span>
		<span class="nc">StringEntity</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringEntity</span><span class="o">(</span><span class="n">postjson</span><span class="o">,</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">));</span>
		<span class="n">entity</span><span class="o">.</span><span class="na">setContentEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
		<span class="n">entity</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">);</span>
		<span class="n">httpPost</span><span class="o">.</span><span class="na">setEntity</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">HttpResponse</span> <span class="n">httpResponse</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">httpPost</span><span class="o">);</span>
			<span class="nc">HttpEntity</span> <span class="n">httpEntity</span> <span class="o">=</span> <span class="n">httpResponse</span><span class="o">.</span><span class="na">getEntity</span><span class="o">();</span>
			<span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">EntityUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">httpEntity</span><span class="o">,</span> <span class="s">"utf-8"</span><span class="o">);</span>
			<span class="nc">EntityUtils</span><span class="o">.</span><span class="na">consume</span><span class="o">(</span><span class="n">httpEntity</span><span class="o">);</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"接口( "</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s">" )响应的数据：\n"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<h2 id="apache-apollo">Apache-Apollo</h2>

<h3 id="下载安装包">下载安装包</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://mirrors.tuna.tsinghua.edu.cn/apache/activemq/activemq-apollo/1.7.1/apache-apollo-1.7.1-unix-distro.tar.gz
</code></pre></div></div>

<h3 id="创建实例">创建实例</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">cd</span> ./apache-apollo-1.7.1/bin

./apollo create mqttbroker

</code></pre></div></div>

<h3 id="设置开机自启动服务">设置开机自启动服务</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo ln</span> <span class="nt">-s</span> <span class="s2">"/root/apache-apollo/apache-apollo-1.7.1/bin/mqttbroker/bin/apollo-broker-service"</span> /etc/init.d/apollo-broker-service start
</code></pre></div></div>

<h3 id="修改配置文件">修改配置文件</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim apollo.xml 
</code></pre></div></div>

<h3 id="运行实例">运行实例</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./apache-apollo/apache-apollo-1.7.1/bin/mqttbroker/bin/apollo-broker run
</code></pre></div></div>

<h3 id="结束实例">结束实例</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 46535 是进程pid</span>
killall 46535 <span class="nt">-9</span> 
</code></pre></div></div>

<h3 id="端口">端口</h3>
<ul>
  <li>代理服务 61680</li>
  <li>客户端 61613</li>
</ul>

<h3 id="账户和密码">账户和密码</h3>
<ul>
  <li>账户 admin</li>
  <li>密码 password</li>
</ul>

<h3 id="实例mqttbroker下的目录解释">实例mqttbroker下的目录解释</h3>
<ul>
  <li>bin  运行脚本</li>
  <li>etc  环境配置</li>
  <li>data 存储持久化数据</li>
  <li>log  运行日志</li>
  <li>tmp 临时文件</li>
  <li>etc文件夹下配置文件说明
    <ul>
      <li>users.properties：
        <ul>
          <li>用来配置可以使用服务器的用户以及相应的密码。</li>
          <li>其在文件中的存储方式是：用户名=密码，如：admin=password</li>
          <li>表示新增一个用户，用户名是：admin，密码是：password</li>
        </ul>
      </li>
      <li>groups.properties：
        <ul>
          <li>持有群体的用户映射，可以通过组而不是单个用户简化访问控制列表。</li>
          <li>可以为一个定义的组设置多个用户，用户之间用<code class="language-plaintext highlighter-rouge">|</code>隔开，如：<code class="language-plaintext highlighter-rouge">admins=admin|lily</code>,表示admins组中有admin和lily两个用户</li>
        </ul>
      </li>
      <li>black-list.txt
        <ul>
          <li>用来存放不允许连接服务器的IP地址，相当于黑名单类似的东西。例如：<code class="language-plaintext highlighter-rouge">10.20.9.147</code></li>
          <li>表示上面IP不能够连接到服务器。</li>
        </ul>
      </li>
      <li>login.config：
        <ul>
          <li>是一个服务器认证的配置文件，为了安全apollo1.6版本提供了认证功能，只有相应的</li>
          <li>用户名和正确的密码才能够连接服务器。</li>
        </ul>
      </li>
      <li>服务器主配置文件<code class="language-plaintext highlighter-rouge">apollo.xml</code>：
        <ul>
          <li>该配置文件用于控制打开的端口，队列，安全，虚拟主机设置等。</li>
          <li>认证：可以使用  <code class="language-plaintext highlighter-rouge">&lt;authenticationdomain="internal" /&gt;</code></li>
          <li>来配置是否需要连接认证，如果将其属性enable设置为false表示不用认证，任何人都可以连接服务器，默认为true</li>
          <li>access_rule：可以在broker或者virtual_host中用于定义用户对服务器资源的各种行为。如: 
<code class="language-plaintext highlighter-rouge">&lt;access_rule allow="users" action="connect create destroy send receive consume"/&gt;</code>表示群组users里面的用户可以对服务器资源进行的操作有：connect 、create、 destroy、 send 、receive 、consume。详细的操作说明见：<a href="http://activemq.apache.org/apollo/documentation/user-manual.html">文档</a></li>
        </ul>
      </li>
      <li>message stores：
        <ul>
          <li>默认情况下apollo使用的是LevelDB store，但是推荐使用BDB store（跨平台的）只能够实用其中一种。使用LevelDB store的配置是:  <code class="language-plaintext highlighter-rouge">&lt;leveldb_store directory="${apollo.base}/data"/&gt;</code>默认有提供不用任何修改。使用BDB store需要到网站下<a href="http://download.oracle.com/maven/com/sleepycat/je/5.0.34/je-5.0.34.jar">jar</a>包，支持将jar包放在服务器的lib目录下面，然后将配置文件改成：  <code class="language-plaintext highlighter-rouge">&lt;bdb_store directory="${apollo.base}/data"/&gt;</code>即可。</li>
        </ul>
      </li>
      <li>connector：用于配置服务器支持的链接协议以及相应的端口。如:<code class="language-plaintext highlighter-rouge">&lt;connector id="tcp" bind="tcp://0.0.0.0:61613" connection_limit="2000" protocol="mqtt"/&gt;</code>
        <ul>
          <li>表示支持tcp链接，使用的端口是61613，链接限制是2000，自动侦听的协议是mqtt协议。具体查看：<a href="http://activemq.apache.org/apollo/documentation/user-manual.html">文档</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="mosquitto">Mosquitto</h2>

<h3 id="安装">安装</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>mosquitto
</code></pre></div></div>

<h3 id="查看帮助">查看帮助</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mosquitto <span class="nt">--help</span>
</code></pre></div></div>

<blockquote>
  <p>mosquitto [-c config_file] [-d] [-h] [-p port]</p>
  <ul>
    <li>-c : specify the broker config file.</li>
    <li>-d : put the broker into the background after starting.</li>
    <li>-h : display this help.</li>
    <li>-p : start the broker listening on the specified port.</li>
    <li>Not recommended in conjunction with the -c option.</li>
    <li>-v : verbose mode - enable all logging types. This overrides</li>
    <li>any logging options given in the config file.</li>
  </ul>
</blockquote>

<h3 id="修改配置文件-1">修改配置文件</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/mosquitto/mosquitto.conf
</code></pre></div></div>

<h3 id="运行">运行</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl start mosquitto
</code></pre></div></div>

<h3 id="停止">停止</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl stop mosquitto
</code></pre></div></div>

<h1 id="mqtt-client">MQTT client</h1>

<blockquote>
  <p>pom.xml</p>
</blockquote>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.eclipse.paho<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>org.eclipse.paho.client.mqttv3<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>1.0.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<blockquote>
  <p>Config.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="c1">// http api publish mqtt payload</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">EMQTT_HTTP_API_URL</span> <span class="o">=</span> <span class="s">"http://yibuwulianwang.com:18000/api/v2/mqtt/publish"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">EMQTT_USER_PASSWORD</span> <span class="o">=</span> <span class="s">"admin:public"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">EMQTT_CLIEND_ID</span> <span class="o">=</span> <span class="s">"iot"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">EMQTT_TOPIC</span> <span class="o">=</span> <span class="s">"yibuwulianwang"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">QOS</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">BROKER</span> <span class="o">=</span> <span class="s">"tcp://yibuwulianwang.com:1883"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">USER_NAME</span> <span class="o">=</span> <span class="s">"SpringMVC"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">USER_PASSWORD</span> <span class="o">=</span> <span class="s">"yibuwulianwang"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">OAUTH_SCOPE</span><span class="o">=</span><span class="s">"basic email"</span><span class="o">;</span>
<span class="o">}</span>

</code></pre></div></div>

<blockquote>
  <p>MyMqttClient.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.yibuwulianwang.mqtt</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttConnectOptions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttPersistenceException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttTopic</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.persist.MemoryPersistence</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSONObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yibuwulianwang.config.Config</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yibuwulianwang.http.HttpResponseStatus</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyMqttClient</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">MemoryPersistence</span> <span class="n">persistence</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">MqttClient</span> <span class="n">sampleClient</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">MqttConnectOptions</span> <span class="n">connOpts</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">MqttTopic</span> <span class="n">topic11</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">static</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">persistence</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemoryPersistence</span><span class="o">();</span>
			<span class="n">sampleClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MqttClient</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">BROKER</span><span class="o">,</span> <span class="nc">Config</span><span class="o">.</span><span class="na">EMQTT_CLIEND_ID</span><span class="o">,</span> <span class="n">persistence</span><span class="o">);</span>
			<span class="n">connOpts</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MqttConnectOptions</span><span class="o">();</span>
			<span class="n">connOpts</span><span class="o">.</span><span class="na">setCleanSession</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
			<span class="n">connOpts</span><span class="o">.</span><span class="na">setUserName</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">USER_NAME</span><span class="o">);</span>
			<span class="n">connOpts</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">USER_PASSWORD</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">());</span>
			<span class="c1">// 设置超时</span>
			<span class="n">connOpts</span><span class="o">.</span><span class="na">setConnectionTimeout</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
			<span class="c1">// 设置心跳</span>
			<span class="n">connOpts</span><span class="o">.</span><span class="na">setKeepAliveInterval</span><span class="o">(</span><span class="mi">130</span><span class="o">);</span>
			<span class="c1">// 设置回调</span>
			<span class="n">sampleClient</span><span class="o">.</span><span class="na">setCallback</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyMqttCallback</span><span class="o">());</span>

			<span class="n">topic11</span> <span class="o">=</span> <span class="n">sampleClient</span><span class="o">.</span><span class="na">getTopic</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">EMQTT_TOPIC</span><span class="o">);</span>
			<span class="c1">// 创建连接</span>
			<span class="n">sampleClient</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">connOpts</span><span class="o">);</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">sampleClient</span><span class="o">.</span><span class="na">isConnected</span><span class="o">())</span> <span class="o">{</span>
				<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Mqtt Client Success Connecting To Mqtt Broker Server"</span><span class="o">);</span>
			<span class="o">}</span>

			<span class="c1">// 订阅主题</span>
			<span class="n">sampleClient</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">EMQTT_TOPIC</span><span class="o">,</span> <span class="nc">Config</span><span class="o">.</span><span class="na">QOS</span><span class="o">);</span>
			<span class="c1">// 断开连接</span>
			<span class="c1">// sampleClient.disconnect();</span>

		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">MqttException</span> <span class="n">me</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"/mqtt"</span><span class="o">,</span><span class="s">"reason "</span> <span class="o">+</span> <span class="n">me</span><span class="o">.</span><span class="na">getReasonCode</span><span class="o">()+</span><span class="s">"msg "</span> <span class="o">+</span> <span class="n">me</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span>
			<span class="o">+</span><span class="s">"loc "</span> <span class="o">+</span> <span class="n">me</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">()+</span><span class="s">"cause "</span> <span class="o">+</span> <span class="n">me</span><span class="o">.</span><span class="na">getCause</span><span class="o">()+</span><span class="s">"excep "</span> <span class="o">+</span> <span class="n">me</span><span class="o">);</span>
			<span class="c1">//me.printStackTrace();</span>
		<span class="o">}</span>
	<span class="o">}</span>


	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">publishMqttPayload</span><span class="o">(</span><span class="nc">String</span> <span class="n">json</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">MqttMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MqttMessage</span><span class="o">(</span><span class="n">json</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
			<span class="n">message</span><span class="o">.</span><span class="na">setRetained</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span><span class="c1">//设置是否保留消息</span>
			<span class="n">message</span><span class="o">.</span><span class="na">setQos</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">QOS</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">sampleClient</span><span class="o">.</span><span class="na">isConnected</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">sampleClient</span><span class="o">.</span><span class="na">publish</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">EMQTT_TOPIC</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="c1">// 客户端连接</span>
				<span class="n">sampleClient</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">connOpts</span><span class="o">);</span>
				<span class="n">publishMqttPayload</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">MqttPersistenceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">MqttException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">MqttClient</span> <span class="nf">getSampleClient</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">sampleClient</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">MqttConnectOptions</span> <span class="nf">getConnOpts</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">connOpts</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<blockquote>
  <p>MyMqttCallback.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.yibuwulianwang.mqtt</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.IMqttDeliveryToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttCallback</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttSecurityException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.fastjson.TypeReference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yibuwulianwang.config.Config</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyMqttCallback</span> <span class="kd">implements</span> <span class="nc">MqttCallback</span> <span class="o">{</span>
	<span class="kd">static</span> <span class="kt">int</span>  <span class="n">connects</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">connectionLost</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">(</span><span class="n">connects</span><span class="o">&gt;=</span><span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyMqttCallback.connectionLost()"</span><span class="o">,</span><span class="s">"MQTT多次重连失败，可能存在客户端ID冲突："</span><span class="o">+</span><span class="nc">Config</span><span class="o">.</span><span class="na">EMQTT_CLIEND_ID</span><span class="o">);</span>
    		<span class="k">try</span> <span class="o">{</span>
				<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="o">}</span>
    		<span class="n">connects</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
		<span class="o">}</span>
        <span class="k">if</span><span class="o">(!</span><span class="nc">MyMqttClient</span><span class="o">.</span><span class="na">getSampleClient</span><span class="o">().</span><span class="na">isConnected</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">connects</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
        	<span class="k">try</span> <span class="o">{</span>
				<span class="n">connects</span><span class="o">++;</span>
				<span class="nc">MyMqttClient</span><span class="o">.</span><span class="na">getSampleClient</span><span class="o">().</span><span class="na">connect</span><span class="o">(</span><span class="nc">MyMqttClient</span><span class="o">.</span><span class="na">getConnOpts</span><span class="o">());</span>
        		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyMqttCallback.connectionLost()"</span><span class="o">,</span><span class="s">"MQTT正在重连-cause:"</span><span class="o">+</span><span class="n">cause</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">MqttSecurityException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyMqttCallback.connectionLost()"</span><span class="o">,</span><span class="s">"MQTT正在重-MqttSecurityException-"</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="na">getStackTrace</span><span class="o">());</span>
				<span class="c1">//e.printStackTrace();</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">MqttException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">//e.printStackTrace();</span>
        		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyMqttCallback.connectionLost()"</span><span class="o">,</span><span class="s">"MQTT正在重连-MqttException-"</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="na">getStackTrace</span><span class="o">());</span>
			<span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="nc">MyMqttClient</span><span class="o">.</span><span class="na">getSampleClient</span><span class="o">().</span><span class="na">isConnected</span><span class="o">())</span> <span class="o">{</span>
    		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyMqttCallback.connectionLost()"</span><span class="o">,</span><span class="s">"MQTT重连成功。"</span><span class="o">);</span>
    	<span class="o">}</span><span class="k">else</span> <span class="o">{</span>
    		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyMqttCallback.connectionLost()"</span><span class="o">,</span><span class="s">"MQTT重连失败！"</span><span class="o">);</span>
    	<span class="o">}</span>
    <span class="o">}</span>  

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deliveryComplete</span><span class="o">(</span><span class="nc">IMqttDeliveryToken</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyMqttCallback.deliveryComplete()"</span><span class="o">,</span><span class="s">"MQTT消息发送结果："</span><span class="o">+</span><span class="n">token</span><span class="o">.</span><span class="na">isComplete</span><span class="o">());</span>
    <span class="o">}</span>  

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">messageArrived</span><span class="o">(</span><span class="nc">String</span> <span class="n">topic</span><span class="o">,</span> <span class="nc">MqttMessage</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
<span class="c1">//        System.out.println("接收消息主题 : " + topic);  </span>
<span class="c1">//        System.out.println("接收消息Qos : " + message.getQos());  </span>
<span class="c1">//        System.out.println("接收消息内容 : " + new String(message.getPayload()));</span>
    	  <span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getPayload</span><span class="o">());</span>
    	<span class="k">if</span><span class="o">(</span><span class="n">isJSONValid</span><span class="o">(</span><span class="n">str</span><span class="o">))</span> <span class="o">{</span>
    		<span class="c1">//com.yibuwulianwang.mqtt.publish.MqttPayloadRoot payload = JSON.parseObject(str,com.yibuwulianwang.mqtt.publish.MqttPayloadRoot.class);</span>
		<span class="n">com</span><span class="o">.</span><span class="na">yibuwulianwang</span><span class="o">.</span><span class="na">json</span><span class="o">.</span><span class="na">me</span><span class="o">.</span><span class="na">MyPayloadJson</span> <span class="n">payload</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">str</span><span class="o">,</span><span class="k">new</span> <span class="nc">TypeReference</span><span class="o">&lt;</span><span class="n">com</span><span class="o">.</span><span class="na">yibuwulianwang</span><span class="o">.</span><span class="na">json</span><span class="o">.</span><span class="na">me</span><span class="o">.</span><span class="na">MyPayloadJson</span><span class="o">&gt;()</span> <span class="o">{});</span>
        	<span class="k">try</span> <span class="o">{</span>
        		<span class="k">if</span><span class="o">(!</span><span class="n">payload</span><span class="o">.</span><span class="na">getClientId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">EMQTT_CLIEND_ID</span><span class="o">))</span> <span class="o">{</span><span class="c1">//判断是不是自己发出去的</span>
            		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyMqttCallback.messageArrived()"</span><span class="o">,</span><span class="s">"MQTT收到Json消息："</span><span class="o">+</span><span class="n">str</span><span class="o">);</span>
            		<span class="nc">ProcessingMessages</span><span class="o">.</span><span class="na">processingMsg</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
            	<span class="o">}</span>
    		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyMqttCallback.messageArrived()"</span><span class="o">,</span> <span class="s">"Json Analysis Exception"</span><span class="o">);</span>
    		<span class="o">}</span>
    	<span class="o">}</span><span class="k">else</span> <span class="o">{</span>
    		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyMqttCallback.messageArrived()"</span><span class="o">,</span><span class="s">"MQTT收到字符串消息："</span><span class="o">+</span><span class="n">str</span><span class="o">);</span>
    	<span class="o">}</span>
    <span class="o">}</span> 
<span class="o">}</span>

<span class="cm">/**
 * 判断是不是json
 * 暴力解析:Alibaba fastjson
 * @param test
 * @return
 */</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isJSONValid</span><span class="o">(</span><span class="nc">String</span> <span class="n">test</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">JSONObject</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">test</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JSONException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
                <span class="nc">JSONObject</span><span class="o">.</span><span class="na">parseArray</span><span class="o">(</span><span class="n">test</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JSONException</span> <span class="n">ex1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
     <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span> 

</code></pre></div></div>


</article><br/>
<br/>
<p style="display: block;text-align:center;">©2012-2022 huangdayu.cn(大鱼叔叔的博客) 版权所有，未经授权，不得转载。</p>
<br/>
<a style="display: block;text-align:right;" href="/">Back</a>
      </div>
    </main>
  </body>
</html>