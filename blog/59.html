<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
  <script src="/assets/js/close_copy.js"></script>
  

  
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  <title>JVM应用诊断调优追记</title>

  <link rel="shortcut icon" type="image/x-icon" href="/assets/private/icons/huangdayu.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head><body a="light">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">Back</a><article>
  
  <h1 class="post-header">JVM应用诊断调优追记</h1>

  <p class="post-meta">
    <time datetime="2022-04-07 00:00:00 +0800">2022-04-07</time>
  </p>
  
  <h2 id="前言">前言</h2>

<p>去年写了<a href="/blog/52">JVM应用诊断调优记</a>，由于偷懒，也是草草了事，并没有太深入的分析问题的原因和提供解决问题的思路，所以这是一篇追记，也不排除有第二篇，第三篇。因为，总所周知，我写文章都是浅尝辄止。</p>

<p>发现问题，分析问题并解决问题。这是处理问题的基本思路，可是往往实际情况下，我们却慌慌张张的，没有分析问题的深层次原因就急着解决问题，可能问题得到暂时的解决，但是却没有得到根治，最终背锅的还是自己。</p>

<p>所以，软件领域的性能问题也是如此。常见的性能指标有单位时间吞吐量、响应时间和并发用户数，当这些指标没有达到要求，我们首先要分析性能的瓶颈在哪里，然后再着手解决，一次次的优化之后就能达到理想的性能要求。以下列出几点性能瓶颈的常见原因并尝试提供解决方案。</p>

<h2 id="实现细节问题">实现细节问题</h2>

<p>实现细节其实也指代码质量问题，举一个例子，当查询大量数据中的最后一条数据，错误的做法是查询全部符合条件的数据，然后在代码中取结果集的最后一条数据，这样做将使得查询数据非常缓慢，正确的做法应该是使用SQL只获取最后一条数据，所以对于数据的操作，最好使用数据库的特性给予支持，并且在数据库服务中就实现，而不是将处理逻辑延伸到应用的代码中来。</p>

<p>类似的代码质量问题、设计模式问题、反设计问题比比皆是，这里就不一一赘述了。所以，代码质量检查很重要。</p>

<h2 id="业务逻辑问题">业务逻辑问题</h2>

<p>复杂的业务逻辑设计的应用比比皆是，大多数情况下由于赶工而丢失软件设计所致。那么解决办法自然是优化业务逻辑，将核心的业务逻辑抽象的更加具体，将实现细节隐藏在业务逻辑之外，然后再逐步优化实现细节。以下有几个方向：</p>

<ul>
  <li>可以异步处理的逻辑采用线程池或队列异步处理，但要记得设置合理的线程池大小和队列大小；</li>
  <li>如果处理数据缓慢，则排查是否已经建立数据索引和SQL优化，否则可以考虑使用缓存中间件来解决；</li>
</ul>

<h2 id="数据索引问题">数据索引问题</h2>

<p>数据库是大都数应用都逃不了的话题，除了ACID之外，并发一致性问题就够喝一壶的了。但是我们当下讨论性能问题目前能想到有以下几个优化方向：</p>

<ul>
  <li>建立字段索引</li>
  <li>修改字段索引策略</li>
  <li>优化SQL</li>
  <li>使用缓存中间件</li>
  <li>读写分离</li>
  <li>分库分表</li>
  <li>修改数据库引擎</li>
</ul>

<h2 id="并发安全问题">并发安全问题</h2>

<p>高并发涉及到读写一致性问题，那必然离不开锁，而锁是对应用性能的一大考验，用的不好则非常影响性能，搞不好还会死锁，严重则导致应用假死或宕机。所以，什么样的场景用什么样的锁，锁什么对象都很关键，对锁的优化也是性能调优的一大重点。</p>

<h2 id="资源使用问题">资源使用问题</h2>

<p>Java的资源使用一直是被诟病的。大量对象的创建，回收，对象的什么周期管理等问题都是调优的方向，JVM调优成了Javaer无法避免的话题。通常还有队列，线程池，集合，数组等基础知识所导致的问题。</p>

<p>以分布式或微服务架构为例，一个应用一般情况下都需要跟一个或多个外部组件进行交互，这样的交互必须是稳定的，可靠的，低延迟的。所以，在应用程序内部，我们都使用线程池或队列，那么对于外部服务我们需要配置合理的连接池（jdbc连接池，rpc连接池和http连接池都是tcp连接池）。说到底，这就是资源的高速复用，最小的资源消耗实现最大的性能需求。</p>

<h2 id="通信方式问题">通信方式问题</h2>

<p>上面提到应用与外部服务之间的交互，所以它们之间的通信模式也很关键，因为这涉及到请求处理的效率。常见的模式有同步式、反应式、异步式。毫无疑问，异步式的性能是最佳的，但是这也意味着架构复杂度的提升，当然，用什么样的方式取决于业务的场景，所以近来反应式很受推崇，以为它既是异步的，对架构的复杂度也是可以被接受的。</p>

<p>所以，要想高性能，首选异步式，其次反应式，最后同步式。有一点需要注意的是，反应式是全链路反应式才是有效的，有意义的。</p>

<h2 id="网络带宽问题">网络带宽问题</h2>

<p>对于大量的数据传输或高频率的跨服务调用，都需要在带宽上给予支持。</p>

<ul>
  <li>压缩网络传输数据</li>
  <li>较少跨网络交互</li>
  <li>提升带宽大小</li>
</ul>

<h2 id="应用架构问题">应用架构问题</h2>

<p>一个业务逻辑的调用栈越深，那么消耗就越大，性能就越低，这跟应用架构都有直接关系的。应用架构奠定了调用栈的基数，MVC分层架构的广泛使用就说明了调用栈越简单越好。</p>

<h2 id="服务架构问题">服务架构问题</h2>

<p>现如今，微服务与分布式被极力推崇，一个小型的应用动不动就微服务，严重的是服务粒度很细，服务依赖盘根错节，复杂且冗长的调用链路，业务处理效率被严重影响。所谓资源调度，灵活扩展，弹性伸缩，低耦合度，高度复用等带来的业务并非利大于弊。</p>

<h2 id="系统架构问题">系统架构问题</h2>

<p>一般情况下，应用不会跟性能消耗较大的服务部署在同一个机器上，如ES这样的资源玩家。所以，系统架构的设计也很关键，特别是大规模部署情况下，通过负载均衡与就近分配原则，自然处理用户请求的服务距离用户最近是性能最高的一种设计。</p>

<h2 id="外部框架问题">外部框架问题</h2>

<p>使用开源框架是必然的，框架的利弊优略则相当重要，而且想Spring这样的霸主，简直成了应用的基石，一旦框架本身出现了问题，选型不对或者使用框架不当，带来的成本也是巨大的，这可能不止性能问题，可能还有安全等问题。现在也冒出了许多号称轻量级的框架，我想也许是一个好的迹象。</p>

<h2 id="机器资源问题">机器资源问题</h2>

<p>CI/CD盛行，Docker与k8s角逐，都是的资源重复利用的利器。应用的性能跟分配的资源有着直接关系，资源越多性能越高，这是成正比的。所以，有一种粗鄙的做法：要性能，加机器，扩集群。在我看来，加机器资源是最不可取，也是最后保留的手段，不到万不得已或情况紧急的事态下，是不推荐使用的。</p>

<h2 id="小结">小结</h2>

<p>以上讨论了性能调优的一个常见问题和解决思路，也许不是很全面，但也希望为读者提供一些思路，引以为戒。</p>

<p><strong>解决问题要从问题本质着手。</strong></p>

<p align="right">开元4720年弎月初七 广州</p>
<br/>
<a style="display: block;text-align:right;" href="/">Back</a>
<br/>
<p style="display: block;text-align:center;">©2012-2022 huangdayu.cn(大鱼叔叔的博客) 版权所有，未经授权，不得转载。</p>
<br/></article>


      </div>
    </main>
  </body>
</html>